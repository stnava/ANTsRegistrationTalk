---
title: <span style="color:red;">An Exegesis of Registration in <br />Advanced Normalization Tools (*ANTs*)</span>
author: Brian B. Avants (<span style="color:blue;">PENN</span>) and <br />Nicholas J. Tustison (<span style="color:orange;">UVA</span>)
bibliography: REFERENCES.bib
logo:    logo.jpg
output:
  pdf_document:
    toc: true
    highlight: zenburn
  beamer_presentation:
    toc: true
    fig_width: 7
    fig_height: 6
  html_document:
    toc: true
    theme: readable
  revealjs_presentation:
    pandoc_args: [ "--slide-level", "2" ]
    incremental: true
    widescreen: true
    smaller: false
    theme: night
    transition: fade
    highlight: zenburn
    center: true
    self_contained: false
  ioslides_presentation:
    css: atk.css
    incremental: false
    widescreen: true
    smaller: false
    fig_width: 5
---

## 
<div align="center"><img src="./figures/ireland.png" frameborder="0"></img></div>

This talk is online at [http://stnava.github.io/ANTsRegistrationTalk/](http://stnava.github.io/ANTsRegistrationTalk/) with colored [links](http://stnava.github.io/ANTsRegistrationTalk/) meant to be clicked for more information

## we *can* compare apples and oranges ... 

![](./figures/appleorange1.png)

initialization

## we *can* compare apples and oranges ... 

![](./figures/appleorange2.png)

<span style="color:red;">R</span><span style="color:green;">G</span><span style="color:blue;">B</span> affine

## we *can* compare apples and oranges ... 

![](./figures/appleorange3.png)

<span style="color:red;">R</span><span style="color:green;">G</span><span style="color:blue;">B</span> deformable registration - i.e. registration on color

# *ANTs* optimizes mathematically <br /> well-defined  <br /><span style="color:red;">objective functions</span>  <br />guided by <br /> <span style="color:red;">prior knowledge</span>  ...

# plug *your ideas* <br />into our software: <br /> <span style="color:blue;"> <span style="color:red;">innovation, insight</span> <br />from biomedical data</span> ...


## ANTs Lineage 

![](./figures/lineage.jpg)

## Diffeomorphisms

<div align="center"><img width="1433" src="./figures/sillyputty.png" frameborder="0"></img></div>

plausible physical modeling of large, invertible deformations

"differentiable map with differentiable inverse"

## Fine-grained and flexible maps
![](./figures/highresdiffeos.jpg)

## ANTs: Beyond Registration

![](./figures/antscapabilities.jpg)

[Atropos](http://www.ncbi.nlm.nih.gov/pubmed/?term=atropos+tustison) segmentation, [N4 inhomogeneity correction](http://www.ncbi.nlm.nih.gov/pubmed/?term=N4+tustison), [Eigenanatomy](http://www.ncbi.nlm.nih.gov/pubmed/?term=eigenanatomy+avants), [SCCAN](http://www.ncbi.nlm.nih.gov/pubmed/?term=sparse+canonical+avants), [Prior-constrained PCA](http://www.ncbi.nlm.nih.gov/pubmed/24852460), and [atlas-based label fusion](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC4009425/) and [MALF](http://www.ncbi.nlm.nih.gov/pubmed/21237273) (powerful expert systems for segmentation)

but *this talk* focuses on the core registration functionality that is critical to the applications above


## Founding developers

<div align="center"><img width="1433" src="./figures/bant2.png" frameborder="0"></img></div>


## Long-term collaborators

![](./figures/antscollab.jpg)


$+$ [neurodebian](http://neuro.debian.net/pkgs/ants.html), [slicer](http://www.slicer.org/), [brainsfit](https://github.com/BRAINSia/BRAINSTools), [nipype](http://nipy.sourceforge.net/nipype/), [itk](http://www.itk.org) and more ...

## General purpose library for multivariate image registration, segmentation & statistical analysis tools

* 170,000+ lines of C++, 6$+$ years of work, 15+ collaborators. 

* Generic mathematical methods that are tunable for 
application specific domains:  no-free lunch

* Deep testing on multiple platforms ... osx, linux, windows.

* Several "wins" in public knock-abouts ( [Klein 2009](http://www.ncbi.nlm.nih.gov/pubmed/19195496), [Murphy 2011](http://www.ncbi.nlm.nih.gov/pubmed/21632295), [SATA 2012 and 2013](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3837555/), [BRATS 2013](http://martinos.org/qtim/miccai2013/proc_brats_2013.pdf), others ) 

```
    An algorithm must use prior knowledge about a problem 
    to do well on that problem 
```

# <span style="color:red;">Medical Image Registration</span> <br /> Fundamental tool for<br /> morphometry, segmentation,<br /> motion estimation and <br /> <span style="color:blue;">data cleaning</span>

## Definitions

* Registration $=$ estimate an "optimal" geometric mapping between image pairs or image sets (e.g. Affine)

* Similarity $=$ a function relating one image to another, given a transformation (e.g. mutual information)

* <span style="color:grey;">
Diffeomorphisms $=$ differentiable map with differentiable inverse (e.g. "silly putty", viscous fluid)  </span>

* Segmentation $=$ labeling tissue or anatomy in images, usually automated (e.g. K-means)

* <span style="color:grey;"> Multivariate $=$ using many voxels or measurements at once (e.g. PCA, $p >> n$ ridge regression)</span>

* Multiple modality $=$ using many modalities at once (e.g. DTI and T1 and BOLD)


## The Technical Framework

![](./figures/designprinciples.png)


## ANTs Nomenclature / Standards 
![](./figures/antsnomen1.jpg)

## ANTs Nomenclature / Standards 
![](./figures/antsnomen2.jpg)

## ANTs Nomenclature / Standards 
![](./figures/antsnomen3.jpg)

## ANTs Nomenclature / Standards 
![](./figures/antsnomen4.jpg)


## The *A*-team of similarity metrics

![](./figures/towardsstandardmetric.png)

$$ \| I - J \| ~~~~~~~~~~~~~~~~~~~ \frac{< I, J >}{\|I\|\|J\|} ~~~~~~~~~~~~~~~ p(I,J) log \frac{p(I,J)}{p(I)p(J)}$$

**all metrics** may be computed from **sparse** or **dense** samples and used with low or high-dimensional transformations

 
## The optimization problem

Find mapping $$ \color{red}{ \phi(x,p) \in \mathcal{T} }$$ such that

$$ \color{red}{ M(I,J,\phi(x,p)) } $$ is minimized

Must select both metric $\color{red}{M}$ and transformation $\color{red}{\mathcal{T}}$

... in addition to optimizer and the problem's resolution


## Concatenated transformation / metric stages are necessary in real data

1.  Start with a *rigid transformation*:  $I \approx J(R(x))$ s.t. negative $MI(I,J,R)$ is minimized

2.  Follow by an *affine transformation*:  $I \approx J(A(R(x)))$ s.t. negative $MI(I,J,A \circ R)$ is minimized with fixed $R$

3.  Finally, a *diffeomorphism*:  $I \approx J(\phi(A(R(x))))$ s.t. $k$-neighborhood correlation $CC_k(I,J,A \circ R)$ is minimized with fixed $R, A$

4.  Output the *composite transform* $A \circ R$ as a matrix transformation and $\phi$ and $\phi^{-1}$ as deformation fields.

standard in [recommended](http://stnava.github.io/ANTsDoc/) `antsRegistration` application scripts 

## Optimizing registration benefits from *optimal sampling strategy*

* sampling for *both* the metric and the transformation

* overall, relatively little translational work on this important problem in biomedical imaging

* impacts scalability, memory, optimization accuracy, speed, robustness ...

* doable, but needs investment in order to achieve "dream" registration scenario

* important for new schemes that *elect* solutions from **anatomical or transformation** dictionaries

# Registration with priors 

## prior knowledge about how to map - e.g. lesion brains

> a test 
>> is the best


## we need to deform ( but not the lesion )

## with landmarks ... two metrics 

## important in segmentation: brain extraction, segmentation, anatomical labeling

* general purpose 

* can use library of shapes to identify objects ...


## building templates

# ANTs in competition

## "grand challenges"

## ANTs versus Freesurfer 

# ANTs statistics: *ANTsR* 

## ANTsR code example 

## PTBP 

## BRATS competition

## ANTsR: EANAT 

## ANTsR: SCCAN 


# Registration: Frontiers and Innovation

## coordinated multivariate statistical fields arise from this mapping

![images at measurement fields](figures/statisticalfields.png)


# Analysis philosophy and <br /> published opinions

## What is and *is not* image registration

[*not* registration](http://www.ncbi.nlm.nih.gov/pubmed/23116330)

## Voodoo in voxel-based analysis

[logical circularity VBA](http://www.ncbi.nlm.nih.gov/pubmed/?term=logical+circularity+tustison)

## Instrumentation bias in the use and evaluation of software

[Instrumentation bias in the use and evaluation of software](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3766821/?report=reader)

# Conclusion

## Recap

- Powerful, general-purpose, <span style="color:red;">well-evaluated</span> registration and segmentation.

- Differentiable maps with differentiable inverse <span style="color:red;">$+$ statistics in these spaces</span>

- Evaluated in multiple problem domains</span> via internal studies & open competition

- Borg philosophy: <span style="color:red;">"best of"</span> from I/O, to processing to statistical methods

- Open source, testing, many examples, consistent style, multiple platforms,  active community support ...

- Integration with *R* $+$ novel tools for prediction, decoding, high-to-low dimensional statistics.

- Collaborations with [neurodebian](http://neuro.debian.net/pkgs/ants.html), [slicer](http://www.slicer.org/), [brainsfit](https://github.com/BRAINSia/BRAINSTools), [nipype](http://nipy.sourceforge.net/nipype/), [itk](http://www.itk.org) and more ...


## Challenges: Computational and Scientific

- Scalability: **need to fuse feature selection methods with transformation optimization**
- Scalability: **need to leverage existing ITK streaming infrastructure in application level tool**
- Domain expertise: Customizable for specific problems but sometimes not specific enough
- Rapid development: colleagues still need familiarity with compilation for latest ANTs features
- Latest theoretical advances in registration not yet wrapped for users
- Need more [Documentation](http://stnava.github.io/ANTs/)  & [testing](http://testing.psychiatry.uiowa.edu/CDash/index.php?project=ANTS) ...

## Tools you can use for imaging science

- Core developers:  *B. Avants, N. Tustison, H. J. Johnson, J. T. Duda*

- Many contributors, including users ...

- Multi-platform, multi-threaded C++ [stnava.github.io/ANTs](stnava.github.io/ANTs)

- Developed in conjunction with [http://www.itk.org/](http://www.itk.org/)

- R wrapping and extension [stnava.github.io/ANTsR](stnava.github.io/ANTsR)

- rapid development, regular testing $+$ many eyes $\rightarrow$ bugs are shallow

<img style="float: right" src="figures/penn.png" />
<img style="float: left" src="figures/picsl.jpg" />



## References {#reffont}

